<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cpld_gridgen: cpldgrid_gen</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cpld_gridgen
   &#160;<span id="projectnumber">1.13.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">cpldgrid_gen </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1"></a>
Introduction</h1>
<p>The cpld_gengrid program and associated script related functions create the files required for Fix and IC files for the coupled model.</p>
<p>This document is part of the <a href="../index.html">UFS_UTILS documentation</a>.</p>
<p>The cpld_gengrid program is part of the <a href="https://github.com/ufs-community/UFS_UTILS">UFS_UTILS</a> project.</p>
<h2><a class="anchor" id="autotoc_md2"></a>
Creating Fix and IC files required for the Coupled Model</h2>
<p>For the UFS coupled model applications, the following fix files are required, either for IC warmstart creation, at runtime, or for post-processing.</p>
<ul>
<li>The CICE6 grid and mask file</li>
<li>The mesh file for the desired OCN/ICE resolution, which is identical for MOM6 and CICE6.</li>
<li>The mapped ocean mask on the FV3 tiles</li>
<li>The ESMF regridding weights required to map a 1/4 deg MOM6 or CICE6 tripole restart file to a lower tripole resolution.</li>
<li>The latitude,longitude,depth and mask arrays required by WW3 to create a mod_def file for a tripole grid.</li>
<li>The ESMF regridding weights required to remap the CICE6 or MOM6 output from tripole grid to a rectilinear grid (optional).</li>
</ul>
<p>Since MOM6 creates the model grid at runtime (including adjusting the land mask, if required), the required files for CICE and UFSAtm must be created in a pre-processing step using only the MOM6 supergrid, topography and land mask files as input. This allows the mapped ocean mask (used for creating of the ATM ICs) and the CICE6 grid and mask files to be consistent with the run-time configuration of MOM6.</p>
<h2><a class="anchor" id="autotoc_md3"></a>
Background:</h2>
<h3><a class="anchor" id="autotoc_md4"></a>
MOM6 grids</h3>
<p>The MOM6 supergrid contains a MOM6 grid at twice the desired resolution. The indexing of the supergrid vs the reduced grid is:</p>
<pre class="fragment">        Super Grid               Reduced Grid


    I-1,J+1     I+1,J+1
       X─────X─────X            I-1,J   i,j
       │     │     │               X─────X
       │     │     │               │     │
       │    i│j    │               │  T  │
       X─────X─────X               │     │
       │     │     │               X─────X
       │     │     │          I-1,J-1    I,J-1
       │     │     │
       X─────X─────X
    I-1,J-1     I+1,J-1
</pre><p>MOM6 uses an Arakawa C grid. Within cpld_gridgen, these are referred to as "stagger" locations, and named as follows: </p><pre class="fragment">             Bu────Cv─────Bu
             │            │
             │            │
             Cu    Ct     Cu
             │            │
             │            │
             Bu────Cv─────Bu
</pre><h3><a class="anchor" id="autotoc_md5"></a>
Rotation angles</h3>
<p>For the tripole grid, a rotation angle is defined to translate vectors to/from the grid (i-j) orientation from/to true E-W. The rotation angle on <code>Ct</code> grid points is calculated at run-time in MOM6 (src/initialization/MOM_shared_initialization.F90). However, CICE6 requires a rotation at the corner (<code>Bu</code>) grid points. To find these angles, the rotation angle on <code>Ct</code> points on the opposite side of the tripole fold are used. In cpld_gridgen, these values are found by "flipping over" and changing the sign of the values on the last row of the MOM6 grid. If <code>ipL</code> and <code>ipR</code> are the i-indices of the poles along the last j-row:</p>
<pre class="fragment">            ipL-1     ipL    ipL+1            ipR-1     ipR    ipR+1
               x-------x-------x     |||        x-------x-------x
</pre><p>then after folding along the tripole seam, <code>ipL</code> and <code>ipR</code> must align:</p>
<pre class="fragment">                           ipR+1     ipR    ipR-1
                              x-------x-------x
                           ipL-1     ipL    ipL+1
                              x-------x-------x
</pre><p>Using the folded seam, the values of the rotation on <code>Ct</code> points across the seam are known. The same procedure that CICE uses internally to calculate the <code>Ct</code> angles from the <code>Bu</code> angles can be used to instead calculate the <code>Bu</code> angles knowing the <code>Ct</code> angles.</p>
<h3><a class="anchor" id="autotoc_md6"></a>
SCRIP format files</h3>
<p>For calculating interpolation weights using ESMF, a SCRIP file needs to be provided. A SCIP file contains the both the grid locations of any stagger grid location (e.g. <code>Ct</code>) and the associated grid vertices for that point. As seen from the above diagram, for the <code>Ct</code> points, those grid vertices are given by the <code>Bu</code> grid locations.</p>
<p>SCRIP requires that the vertices be ordered counter-clockwise so that the center grid point is always to the left of the vertex. In cpld_gridgen, vertices are defined counter-clockwise from upper right. <code>Ct</code> vertices are located on the <code>Bu</code> grid (as shown above), <code>Cu</code> vertices on the <code>Cv</code> grid, <code>Cv</code> vertices on the <code>Cu</code> grid and <code>Bu</code> vertices on the <code>Ct</code> grid. For example, for the <code>Ct</code> grid, the vertices are: </p><pre class="fragment">         Vertex #2             Vertex #1
         Bu(i-1,j)             Bu(i,j)
                     Ct(i,j)
       Bu(i-1,j-1)             Bu(i,j-1)
         Vertex #3             Vertex #4
</pre><p>so that the vertices for the <code>Ct</code> grid are found as off-sets of the i,j index of the <code>Bu</code> grid </p><pre class="fragment"> iVertCt(4) = (/0, -1, -1,  0/)
 jVertCt(4) = (/0,  0, -1, -1/)
</pre><p>Careful examination of the remaining stagger locations lead to similar definitions for the i,j offsets required to extract the vertices, all of which can be defined in terms of the <code>iVertCt</code> and <code>jVertCt</code> values.</p>
<p>Special treatment is require at the bottom of the grid, where the vertices of the <code>Ct</code> and <code>Cu</code> grid must be set manually (note, these points are on land.) The top of the grid also requires special treatment because the required vertices are located across the tripole seam. This is accomplished by creating 1-d arrays which hold the <code>Ct</code> and <code>Cu</code> grid point locations across the matched seam.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Generating the grid files</h2>
<p>The cpld_gridgen program and associated script related functions perform the following tasks:</p>
<ol type="1">
<li>read the MOM6 supergrid and ocean mask file and optionally creates the required <em>topo_edits</em> file if the land mask for MOM6 is to be changed at runtime.</li>
<li>create a master grid file containing all stagger locations of the grid fully defined</li>
<li>create the CICE6 grid variables and writes the required CICE6 grid file</li>
<li>create a SCRIP file for the center stagger (<code>Ct</code>) grid points and a second SCRIP file also containing the land mask</li>
<li>create the ESMF conservative regridding weights to map the ocean mask to the FV3 tiles and write the mapped mask to 6 tile files</li>
<li>create the ESMF positional weights to map to and from the center <code>Ct</code> grid location.</li>
<li>create the EMSF mapping weights to map a tripole grid to a set of rectilinear grids</li>
<li>use the command line command <em>ESMF_Scrip2Unstruct</em> to generate the ocean mesh from the SCRIP file containing the land mask (item 4)</li>
<li>use an NCO command line command to generate the CICE6 land mask file from the CICE6 grid file</li>
</ol>
<h2><a class="anchor" id="autotoc_md8"></a>
Using ESMF weights for warmstart generation or for ocean-ice post</h2>
<p>The ESMF weights generated by <code>cpld_gridgen</code> are of two types: <b>positional weights</b> and <b>mapping weights</b>. Positional weights are ESMF weights which are used to map to and from the <code>Ct</code> grid location. Mapping weights are weights used to map from one domain to another domain.</p>
<p>In UWM, the ocean and ice <b>always</b> run on the same domain because sea-ice, by definition, can only exist where the ocean exists. The domain of the ocean and ice for the global models is always the tripole grid, which is characterized by three "poles", one in the southern hemisphere and two in the north, both over land.</p>
<div class="image">
<img src="murray.png" alt="murray.png" width="400cm"/>
<div class="caption">
from Murray (1996)</div></div>
<p>As seen in the figure, in the northern hemisphere, the model grid lines (i.e. indices i,j) do not align with true eastward and northward directions. Therefore, velocities for both MOM6 an CICE6 must be "rotated" from the model orientation to true geographic orientation before mapping can take place. This rotation requires that both components of velocity be co-located at the center <code>Ct</code> grid point and requires a set of positional weights <b>on the source grid</b>. In addition, when mapping from one tripole grid to another, weights are required to re-locate the velocities from the center grid point back to the native velocity locations. This requires a second set of positional weights <b>on the destination grid</b>.</p>
<p>For ocean-ice "post", fields located at the center grid point of the source tripole grid are mapped to a destination rectilinear grid. Thus, both positional weights and mapping weights are generated by <code>cpld_gridgen</code> for use by ocean-ice post. For downscaling of ocean or ice restart files the mapping takes place using an ESMF RouteHandle, in order to correctly account for differing land masks. Thus, only the positional weights are required for downscaling of restart files.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
The generated files</h2>
<p>The exact list of files produced by the <em>cpld_gridgen.sh</em> script will vary depending on several factors. To generate positional weights, a SCRIP format file will be produced for each rectilinear destination grid desired as well for each of the grid locations (<code>Cu</code>,<code>Cv</code> or <code>Bu</code>). Positional weights will be generated <b>to</b> Ct on the source grid and <b>from</b> Ct on a destination tripole grid. Note also that multiple intermediate SCRIP format files may be produced depending on the source tripole grid.</p>
<p><br />
</p>
<ul>
<li>Executing the script for the 1/4 deg OCN/ICE (<code>mx025</code>) resolution will result in the following files being produced in the output location:</li>
</ul>
<a class="anchor" id="foutmx025"></a>
<table class="doxtable">
<caption>Output files for 1/4 deg</caption>
<tr>
<th>File name </th><th>Description </th><th>Function </th></tr>
<tr>
<td row="1">tripole.mx025.nc </td><td>master grid file </td><td>Creating all subsequent grid or mapping files </td></tr>
<tr>
<td row="2">grid_cice_NEMS_mx025.nc </td><td>the CICE grid file </td><td>used at runtime by CICE6 </td></tr>
<tr>
<td row="3">kmtu_cice_NEMS_mx025.nc </td><td>the CICE mask file </td><td>used at runtime by CICE6 </td></tr>
<tr>
<td row="4">mesh.mx025.nc </td><td>the ocean and ice mesh file </td><td>used at runtime by CICE6, MOM6, and CMEPS </td></tr>
<tr>
<td row="5">C384.mx025.tile[1-6].nc </td><td>the mapped ocean mask on the ATM tiles </td><td>used to create ATM ICs consistent with the <br />
 fractional grid </td></tr>
</table>
<p><br />
</p>
<ul>
<li>The following mapping files will be produced for use by ocean-ice post:</li>
</ul>
<a class="anchor" id="foutpost"></a>
<table class="doxtable">
<caption>Mapping weights for a tripole <b>source resolution</b> </caption>
<tr>
<th>File name </th><th>Function </th></tr>
<tr>
<td row="2">tripole.mx[source resolution].Ct.to.rect.[destination resolution].[bilinear][conserve].nc </td><td>the ESMF weights for mapping variables<br />
 on the center (Ct) stagger location on <br />
 the tripole grid to a rectilinear grid <br />
 with [destination resolution] using <br />
 either bilinear or conservative mapping </td></tr>
</table>
<p><br />
</p>
<ul>
<li>The following positional weight files will be produced in the output location for use by both ocean-ice post as well as ocean-ice prep.</li>
</ul>
<a class="anchor" id="fouttripole"></a>
<table class="doxtable">
<caption>Positional weights on tripole <b>source</b> and <b>destination</b> resolution</caption>
<tr>
<th>File name </th><th>Function </th></tr>
<tr>
<td row="1">tripole.mx[source resolution].[Cu][Cv][Bu].to.Ct.bilinear.nc </td><td><p class="starttd">the ESMF weights for mapping OCN or ICE <br />
 output fields from the various stagger <br />
 locations on the tripole grid to the <br />
 center (Ct) stagger location on the <br />
 same tripole grid using bilinear mapping</p>
<p class="endtd"></p>
</td></tr>
<tr>
<td row="1">tripole.mx[destination resolution].Ct.to.[Cu][Cv][Bu].bilinear.nc </td><td>the ESMF weights for mapping downscaled IC values on a <br />
 tripole grid from Ct locations to the native stagger locations </td></tr>
</table>
<p><br />
</p>
<ul>
<li>If run-time land mask changes for MOM6 are requested, the following file will be produced in the output location:</li>
</ul>
<a class="anchor" id="fouttopo"></a>
<table class="doxtable">
<caption>Output files for run-time modification of MOM6 land mask</caption>
<tr>
<th>File name </th><th>Function </th></tr>
<tr>
<td row="1">ufs.[Default filename].nc </td><td>Topo-edits required for UFS application. These are appended to the existing default topo <br />
 edits file and implemented at run time with the parameter flag <br />
 <code>ALLOW_LANDMASK_CHANGES=true</code>. All files produced by the <em>cpld_gridgen.sh</em> will be <br />
 consistent with this run-time land mask. </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
