<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>cpld_gridgen: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">cpld_gridgen
   &#160;<span id="projectnumber">1.12.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">cpld_gridgen Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Introduction</h1>
<p>The cpld_gengrid program and associated script related functions create the files required for Fix and IC files for the coupled model.</p>
<p>This document is part of the <a href="../index.html">UFS_UTILS documentation</a>.</p>
<p>The cpld_gengrid program is part of the <a href="https://github.com/ufs-community/UFS_UTILS">UFS_UTILS</a> project.</p>
<h2>Creating Fix and IC files required for the Coupled Model</h2>
<p>For the UFS coupled model application S2S or S2SW, the following fix files are required:</p>
<ul>
<li>The CICE6 grid and mask file</li>
<li>The mesh file for the desired OCN/ICE resolution, which is identical for MOM6 and CICE6.</li>
<li>The mapped ocean mask on the FV3 tiles</li>
<li>The ESMF regridding weights required to create the CICE6 IC from CPC (SIS2) reanalysis.</li>
<li>The ESMF regridding weights required to remap the CICE6 or MOM6 output from tripole grid to a rectilinear grid (optional).</li>
</ul>
<p>Since MOM6 creates the model grid at runtime (including adjusting the land mask, if required), the required files for CICE and UFSAtm must be created in a pre-processing step using only the MOM6 supergrid, topography and land mask files as input. This allows the mapped ocean mask (used for creating of the ATM ICs) and the CICE6 grid and mask files to be consistent with the run-time configuration of MOM6.</p>
<h2>Background:</h2>
<h3>MOM6 grids</h3>
<p>The MOM6 supergrid contains a MOM6 grid at twice the desired resolution. The indexing of the supergrid vs the reduced grid is:</p>
<pre class="fragment">        Super Grid               Reduced Grid


    I-1,J+1     I+1,J+1
       X─────X─────X            I-1,J   i,j
       │     │     │               X─────X
       │     │     │               │     │
       │    i│j    │               │  T  │
       X─────X─────X               │     │
       │     │     │               X─────X
       │     │     │          I-1,J-1    I,J-1
       │     │     │
       X─────X─────X
    I-1,J-1     I+1,J-1
</pre><p>MOM6 uses an Arakawa C grid. Within cpld_gridgen, these are referred to as "stagger" locations, and named as follows: </p>
<pre class="fragment">             Bu────Cv─────Bu
             │            │
             │            │
             Cu    Ct     Cu
             │            │
             │            │
             Bu────Cv─────Bu
</pre><h3>Rotation angles</h3>
<p>For the tripole grid, a rotation angle is defined to translate vectors to/from the grid (i-j) orientation from/to true E-W. The rotation angle is calculated at run-time in MOM6 (src/initialization/MOM_shared_initialization.F90). However, CICE6 requires a rotation at the corner (<code>Bu</code>) grid points, which for points along the tripole seam requires values on the other side of the tripole fold. In cpld_gridgen, these values are found by "flipping over" the values on the last row of the MOM6 super-grid. If <code>ipL</code> and <code>ipR</code> are the i-indices of the poles along the last j-row:</p>
<pre class="fragment">            ipL-1     ipL    ipL+1            ipR-1     ipR    ipR+1
               x-------x-------x     |||        x-------x-------x
</pre><p>then after folding along the tripole seam, <code>ipL</code> and <code>ipR</code> must align:</p>
<pre class="fragment">                           ipR+1     ipR    ipR-1
                              x-------x-------x
                           ipL-1     ipL    ipL+1
                              x-------x-------x
</pre><p>Using the folded seam, the values required for calculating the rotation angle on the <code>Bu</code> grid points are available and can be calculated in the same way as MOM6 calculates rotation angles for the <code>Ct</code> grid points.</p>
<h3>SCRIP format files</h3>
<p>For calculating interpolation weights using ESMF, a SCRIP file needs to be provided. A SCIP file contains the both the grid locations of any stagger grid location (e.g. <code>Ct</code>) and the associated grid vertices for that point. As seen from the above diagram, for the <code>Ct</code> points, those grid vertices are given by the <code>Bu</code> grid locations.</p>
<p>SCRIP requires that the vertices be ordered counter-clockwise so that the center grid point is always to the left of the vertex. In cpld_gridgen, vertices are defined counter-clockwise from upper right. <code>Ct</code> vertices are located on the <code>Bu</code> grid (as shown above), <code>Cu</code> vertices on the <code>Cv</code> grid, <code>Cv</code> vertices on the <code>Cu</code> grid and <code>Bu</code> vertices on the <code>Ct</code> grid. For example, for the <code>Ct</code> grid, the vertices are: </p>
<pre class="fragment">         Vertex #2             Vertex #1
         Bu(i-1,j)             Bu(i,j)
                     Ct(i,j)
       Bu(i-1,j-1)             Bu(i,j-1)
         Vertex #3             Vertex #4
</pre><p>so that the vertices for the <code>Ct</code> grid are found as off-sets of the i,j index of the <code>Bu</code> grid </p>
<pre class="fragment"> iVertCt(4) = (/0, -1, -1,  0/)
 jVertCt(4) = (/0,  0, -1, -1/)
</pre><p>Careful examination of the remaining stagger locations lead to similar definitions for the i,j offsets required to extract the vertices, all of which can be defined in terms of the <code>iVertCt</code> and <code>jVertCt</code> values.</p>
<p>Special treatment is require at the bottom of the grid, where the vertices of the <code>Ct</code> and <code>Cu</code> grid must be set manually (note, these points are on land.) The top of the grid also requires special treatment because the required vertices are located across the tripole seam. This is accomplished by creating 1-d arrays which hold the <code>Ct</code> and <code>Cu</code> grid point locations across the matched seam.</p>
<h2>Generating the grid files</h2>
<p>The cpld_gridgen program and associated script related functions perform the following tasks:</p>
<ol type="1">
<li>read the MOM6 supergrid and ocean mask file and optionally creates the required <em>topo_edits</em> file if the land mask for MOM6 is to be changed at runtime.</li>
<li>create a master grid file containing all stagger locations of the grid fully defined</li>
<li>create the CICE6 grid variables and writes the required CICE6 grid file</li>
<li>create a SCRIP file for the center stagger (<code>Ct</code>) grid points and a second SCRIP file also containing the land mask</li>
<li>create the ESMF conservative regridding weights to map the ocean mask to the FV3 tiles and write the mapped mask to 6 tile files</li>
<li>create the ESMF regridding weights to map the 1/4 CICE6 restart file to a lower resolution tripole grid</li>
<li>optionally call a routine to generate ESMF regridding weights to map the tripole grid to a set of rectilinear grids</li>
<li>use the command line command <em>ESMF_Scrip2Unstruct</em> to generate the ocean mesh from the SCRIP file containing the land mask (item 4)</li>
<li>use an NCO command line command to generate the CICE6 land mask file from the CICE6 grid file</li>
</ol>
<h2>The generated files</h2>
<p>The exact list of files produced by the <em>cpld_gridgen.sh</em> script will vary depending on several factors. For example, if the <em>DO_POSTWGHTS</em> flag is true, then a SCRIP format file will be produced for each rectilinear destination grid desired and a file containing the regridding weights to map from the center <code>Ct</code> stagger point to the rectilinear grid will also be written. Because both MOM6 and CICE6 velocity variables are located at <code>Cu</code>,<code>Cv</code> or <code>Bu</code> locations, additional files will also be created to regrid from the velocity stagger locations to the center <code>Ct</code> location. If an OCN/ICE grid resolution less than 1/4 degree is chosen, then a file containing regridding weights from the 1/4 degree grid to a lower resolution grid will also be written. Note also that multiple intermediate SCRIP format files may be produced depending on the options chosen.</p>
<p><br/>
</p>
<ul>
<li>Executing the script for the 1/4 deg OCN/ICE resolution will result in the following files being produced in the output location:</li>
</ul>
<table class="doxtable">
<caption id="foutmx025" align="bottom">Output files for 1/4 deg</caption>
<tr>
<th>File name </th><th>Description </th><th>Function </th></tr>
<tr>
<td row="1">tripole.mx025.nc </td><td>master grid file </td><td>Creating all subsequent grid or mapping files </td></tr>
<tr>
<td row="2">grid_cice_NEMS_mx025.nc </td><td>the CICE grid file </td><td>used at runtime by CICE6 </td></tr>
<tr>
<td row="3">kmtu_cice_NEMS_mx025.nc </td><td>the CICE mask file </td><td>used at runtime by CICE6 </td></tr>
<tr>
<td row="4">mesh.mx025.nc </td><td>the ocean and ice mesh file </td><td>used at runtime by CICE6, MOM6, and CMEPS </td></tr>
<tr>
<td row="5">C384.mx025.tile[1-6].nc </td><td>the mapped ocean mask on the ATM tiles </td><td>used to create ATM ICs consistent with the <br/>
 fractional grid </td></tr>
</table>
<p><br/>
</p>
<ul>
<li>If the optional post-weights are generated, the following files will be produced in the output location:</li>
</ul>
<table class="doxtable">
<caption id="foutpost" align="bottom">Optional post-weights files for 1/4deg</caption>
<tr>
<th>File name </th><th>Function </th></tr>
<tr>
<td row="1">tripole.mx025.[Cu][Cv][Bu].to.Ct.bilinear.nc </td><td>the ESMF weights for mapping OCN or ICE <br/>
 output fields from the various stagger <br/>
 locations on the tripole grid to the <br/>
 center (Ct) stagger location on the <br/>
 same tripole grid using bilinear mapping </td></tr>
<tr>
<td row="2">tripole.mx025.Ct.to.rect.[destination resolution].[bilinear][conserve].nc </td><td>the ESMF weights for mapping variables <br/>
 on the center (Ct) stagger location on <br/>
 the tripole grid to a rectilinear grid <br/>
 with [destination resolution] using <br/>
 either bilinear or conservative mapping </td></tr>
</table>
<p><br/>
</p>
<ul>
<li>If a resolution other than 1/4 degree is used in <em>cpld_gridgen.sh</em>, the following file will be produced in the output location:</li>
</ul>
<table class="doxtable">
<caption id="foutcice6" align="bottom">Output files for CICE6 IC creation at tripole destination resolution</caption>
<tr>
<th>File name </th><th>Function </th></tr>
<tr>
<td row="1">tripole.mx025.Ct.to.mx[destination resolution].Ct.neareststod.nc </td><td>the ESMF weights for mapping the 1/4 CICE ICs to <br/>
 a tripole [destination resolution] using nearest <br/>
 source-to-destination mapping </td></tr>
</table>
<p><br/>
</p>
<ul>
<li>If run-time land mask changes for MOM6 are requested, the following file will be produced in the output location:</li>
</ul>
<table class="doxtable">
<caption id="fouttopo" align="bottom">Output files for run-time modification of MOM6 land mask</caption>
<tr>
<th>File name </th><th>Function </th></tr>
<tr>
<td row="1">ufs.[Default filename].nc </td><td>Topo-edits required for UFS application. These are appended to the existing default topo <br/>
 edits file and implemented at run time with the parameter flag <br/>
 <code>ALLOW_LANDMASK_CHANGES=true</code>. All files produced by the <em>cpld_gridgen.sh</em> will be <br/>
 consistent with this run-time land mask. </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
